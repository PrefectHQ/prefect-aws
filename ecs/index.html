
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Integrations with the Amazon Elastic Container Service.">
      
      
      
        <link rel="canonical" href="https://PrefectHQ.github.io/prefect-aws/ecs/">
      
      <link rel="icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.4.1, mkdocs-material-8.5.6">
    
    
      
        <title>ECS - prefect-aws</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#prefect_aws.ecs" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="prefect-aws" class="md-header__button md-logo" aria-label="prefect-aws" data-md-component="logo">
      
  <img src="../img/prefect-logo-mark-solid-white-500.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            prefect-aws
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ECS
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/PrefectHQ/prefect-aws" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="prefect-aws" class="md-nav__button md-logo" aria-label="prefect-aws" data-md-component="logo">
      
  <img src="../img/prefect-logo-mark-solid-white-500.png" alt="logo">

    </a>
    prefect-aws
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/PrefectHQ/prefect-aws" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../batch/" class="md-nav__link">
        Batch
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../client_waiter/" class="md-nav__link">
        Client Waiter
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../credentials/" class="md-nav__link">
        Credentials
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          ECS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        ECS
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prefect_aws.ecs-classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask" class="md-nav__link">
    ECSTask
  </a>
  
    <nav class="md-nav" aria-label="ECSTask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask-attributes" class="md-nav__link">
    Attributes
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.auto_deregister_task_definition" class="md-nav__link">
    auto_deregister_task_definition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.aws_credentials" class="md-nav__link">
    aws_credentials
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.cloudwatch_logs_options" class="md-nav__link">
    cloudwatch_logs_options
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.cluster" class="md-nav__link">
    cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.configure_cloudwatch_logs" class="md-nav__link">
    configure_cloudwatch_logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.cpu" class="md-nav__link">
    cpu
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.execution_role_arn" class="md-nav__link">
    execution_role_arn
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.image" class="md-nav__link">
    image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.launch_type" class="md-nav__link">
    launch_type
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.memory" class="md-nav__link">
    memory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.stream_output" class="md-nav__link">
    stream_output
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.task_customizations" class="md-nav__link">
    task_customizations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.task_definition" class="md-nav__link">
    task_definition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.task_definition_arn" class="md-nav__link">
    task_definition_arn
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.task_role_arn" class="md-nav__link">
    task_role_arn
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.task_start_timeout_seconds" class="md-nav__link">
    task_start_timeout_seconds
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.task_watch_poll_interval" class="md-nav__link">
    task_watch_poll_interval
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.vpc_id" class="md-nav__link">
    vpc_id
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask-methods" class="md-nav__link">
    Methods
  </a>
  
    <nav class="md-nav" aria-label="Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.__json_encoder__" class="md-nav__link">
    __json_encoder__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.cloudwatch_logs_options_requires_configure_cloudwatch_logs" class="md-nav__link">
    cloudwatch_logs_options_requires_configure_cloudwatch_logs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.configure_cloudwatch_logs_requires_execution_role_arn" class="md-nav__link">
    configure_cloudwatch_logs_requires_execution_role_arn()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.dict" class="md-nav__link">
    dict()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.image_is_required" class="md-nav__link">
    image_is_required()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.preview" class="md-nav__link">
    preview()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.set_default_configure_cloudwatch_logs" class="md-nav__link">
    set_default_configure_cloudwatch_logs()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTaskResult" class="md-nav__link">
    ECSTaskResult
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect_aws.ecs-functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.get_container" class="md-nav__link">
    get_container()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.get_prefect_container" class="md-nav__link">
    get_prefect_container()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../s3/" class="md-nav__link">
        S3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../secrets_manager/" class="md-nav__link">
        Secrets Manager
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prefect_aws.ecs-classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask" class="md-nav__link">
    ECSTask
  </a>
  
    <nav class="md-nav" aria-label="ECSTask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask-attributes" class="md-nav__link">
    Attributes
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.auto_deregister_task_definition" class="md-nav__link">
    auto_deregister_task_definition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.aws_credentials" class="md-nav__link">
    aws_credentials
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.cloudwatch_logs_options" class="md-nav__link">
    cloudwatch_logs_options
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.cluster" class="md-nav__link">
    cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.configure_cloudwatch_logs" class="md-nav__link">
    configure_cloudwatch_logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.cpu" class="md-nav__link">
    cpu
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.execution_role_arn" class="md-nav__link">
    execution_role_arn
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.image" class="md-nav__link">
    image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.launch_type" class="md-nav__link">
    launch_type
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.memory" class="md-nav__link">
    memory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.stream_output" class="md-nav__link">
    stream_output
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.task_customizations" class="md-nav__link">
    task_customizations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.task_definition" class="md-nav__link">
    task_definition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.task_definition_arn" class="md-nav__link">
    task_definition_arn
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.task_role_arn" class="md-nav__link">
    task_role_arn
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.task_start_timeout_seconds" class="md-nav__link">
    task_start_timeout_seconds
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.task_watch_poll_interval" class="md-nav__link">
    task_watch_poll_interval
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.vpc_id" class="md-nav__link">
    vpc_id
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask-methods" class="md-nav__link">
    Methods
  </a>
  
    <nav class="md-nav" aria-label="Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.__json_encoder__" class="md-nav__link">
    __json_encoder__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.cloudwatch_logs_options_requires_configure_cloudwatch_logs" class="md-nav__link">
    cloudwatch_logs_options_requires_configure_cloudwatch_logs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.configure_cloudwatch_logs_requires_execution_role_arn" class="md-nav__link">
    configure_cloudwatch_logs_requires_execution_role_arn()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.dict" class="md-nav__link">
    dict()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.image_is_required" class="md-nav__link">
    image_is_required()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.preview" class="md-nav__link">
    preview()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTask.set_default_configure_cloudwatch_logs" class="md-nav__link">
    set_default_configure_cloudwatch_logs()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.ECSTaskResult" class="md-nav__link">
    ECSTaskResult
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect_aws.ecs-functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.get_container" class="md-nav__link">
    get_container()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect_aws.ecs.get_prefect_container" class="md-nav__link">
    get_prefect_container()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/PrefectHQ/prefect-aws/edit/main/docs/ecs.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<div class="doc doc-object doc-module">



<h1 id="prefect_aws.ecs" class="doc doc-heading">
        <code>prefect_aws.ecs</code>



</h1>

    <div class="doc doc-contents first">

      <p><span class="badge-api experimental"/></p>
<p>Integrations with the Amazon Elastic Container Service.</p>
<p>Note this module is experimental. The intefaces within may change without notice.</p>

<p><strong>Examples:</strong></p>
    <p>Run a task using ECS Fargate
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></p>
<p>Run a task using ECS Fargate with a spot container instance
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">],</span> <span class="n">launch_type</span><span class="o">=</span><span class="s2">&quot;FARGATE_SPOT&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></p>
<p>Run a task using ECS with an EC2 container instance
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">],</span> <span class="n">launch_type</span><span class="o">=</span><span class="s2">&quot;EC2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></p>
<p>Run a task on a specific VPC using ECS Fargate
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">],</span> <span class="n">vpc_id</span><span class="o">=</span><span class="s2">&quot;vpc-01abcdf123456789a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></p>
<p>Run a task and stream the container's output to the local terminal. Note an
execution role must be provided with permissions: logs:CreateLogStream,
logs:CreateLogGroup, and logs:PutLogEvents.
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span>
    <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">],</span>
    <span class="n">stream_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">execution_role_arn</span><span class="o">=</span><span class="s2">&quot;...&quot;</span>
<span class="p">)</span>
</code></pre></div></p>
<p>Run a task using an existing task definition as a base
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">],</span> <span class="n">task_definition_arn</span><span class="o">=</span><span class="s2">&quot;arn:aws:ecs:...&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p>Run a task with a specific image
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">],</span> <span class="n">image</span><span class="o">=</span><span class="s2">&quot;alpine:latest&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p>Run a task with custom memory and CPU requirements
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">],</span> <span class="n">memory</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span> <span class="n">cpu</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span>
</code></pre></div></p>
<p>Run a task with custom environment variables
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello $PLANET&quot;</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;PLANET&quot;</span><span class="p">:</span> <span class="s2">&quot;earth&quot;</span><span class="p">})</span>
</code></pre></div></p>
<p>Run a task in a specific ECS cluster
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">],</span> <span class="n">cluster</span><span class="o">=</span><span class="s2">&quot;my-cluster-name&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p>Run a task with custom VPC subnets
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span>
    <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">],</span>
    <span class="n">task_customizations</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/networkConfiguration/awsvpcConfiguration/subnets&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;subnet-80b6fbcd&quot;</span><span class="p">,</span> <span class="s2">&quot;subnet-42a6fdgd&quot;</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div></p>
<p>Run a task without a public IP assigned
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span>
    <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">],</span>
    <span class="n">vpc_id</span><span class="o">=</span><span class="s2">&quot;vpc-01abcdf123456789a&quot;</span><span class="p">,</span>
    <span class="n">task_customizations</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/networkConfiguration/awsvpcConfiguration/assignPublicIp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;DISABLED&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div></p>
<p>Run a task with custom VPC security groups
<div class="highlight"><pre><span></span><code><span class="n">ECSTask</span><span class="p">(</span>
    <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">],</span>
    <span class="n">vpc_id</span><span class="o">=</span><span class="s2">&quot;vpc-01abcdf123456789a&quot;</span><span class="p">,</span>
    <span class="n">task_customizations</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/networkConfiguration/awsvpcConfiguration/securityGroups&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sg-d72e9599956a084f5&quot;</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">],</span>
<span class="p">)</span>
</code></pre></div></p>



  <div class="doc doc-children">








<h2 id="prefect_aws.ecs-classes">Classes</h2>

  <div class="doc doc-object doc-class">



<h3 id="prefect_aws.ecs.ECSTask" class="doc doc-heading">
        <code>
ECSTask            (<span title="prefect.infrastructure.base.Infrastructure">Infrastructure</span>)
        </code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-model"><code>pydantic-model</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p><span class="badge-api experimental"/></p>
<p>Run a command as an ECS task.</p>
<p>Note this block is experimental. The interface may change without notice.</p>

        <details class="quote">
          <summary>Source code in <code>prefect_aws/ecs.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ECSTask</span><span class="p">(</span><span class="n">Infrastructure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &lt;span class=&quot;badge-api experimental&quot;/&gt;</span>

<span class="sd">    Run a command as an ECS task.</span>

<span class="sd">    Note this block is experimental. The interface may change without notice.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_block_type_slug</span> <span class="o">=</span> <span class="s2">&quot;ecs-task&quot;</span>
    <span class="n">_block_type_name</span> <span class="o">=</span> <span class="s2">&quot;ECS Task&quot;</span>
    <span class="n">_logo_url</span> <span class="o">=</span> <span class="s2">&quot;https://images.ctfassets.net/gm98wzqotmnx/1jbV4lceHOjGgunX15lUwT/db88e184d727f721575aeb054a37e277/aws.png?h=250&quot;</span>  <span class="c1"># noqa</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;Run a command as an ECS task. Note this block is experimental. The interface may change without notice.&quot;</span>  <span class="c1"># noqa</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ecs-task&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="s2">&quot;ecs-task&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The slug for this task type.&quot;</span>
    <span class="p">)</span>

    <span class="n">aws_credentials</span><span class="p">:</span> <span class="n">AwsCredentials</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;AWS Credentials&quot;</span><span class="p">,</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">AwsCredentials</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The AWS credentials to use to connect to ECS.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Task definition settings</span>
    <span class="n">task_definition_arn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;An identifier for an existing task definition to use. If fields are set &quot;</span>
            <span class="s2">&quot;on the `ECSTask` that conflict with the task definition, a new copy &quot;</span>
            <span class="s2">&quot;will be registered with the required values. &quot;</span>
            <span class="s2">&quot;Cannot be used with `task_definition`. If not provided, Prefect will &quot;</span>
            <span class="s2">&quot;generate and register a minimal task definition.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">task_definition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;An ECS task definition to use. Prefect may set defaults or override &quot;</span>
            <span class="s2">&quot;fields on this task definition to match other `ECSTask` fields. &quot;</span>
            <span class="s2">&quot;Cannot be used with `task_definition_arn`. If not provided, Prefect will &quot;</span>
            <span class="s2">&quot;generate and register a minimal task definition.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">get_prefect_image_name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The image to use for the Prefect container in the task. If this value is &quot;</span>
            <span class="s2">&quot;not null, it will override the value in the task definition. This value &quot;</span>
            <span class="s2">&quot;defaults to a Prefect base image matching your local versions.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">auto_deregister_task_definition</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If set, any task definitions that are created by this block will be &quot;</span>
            <span class="s2">&quot;deregistered. Existing task definitions linked by ARN will never be &quot;</span>
            <span class="s2">&quot;deregistered. Deregistering a task definition does not remove it from &quot;</span>
            <span class="s2">&quot;your AWS account, instead it will be marked as INACTIVE.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Mixed task definition / run settings</span>
    <span class="n">cpu</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The amount of CPU to provide to the ECS task. Valid amounts are &quot;</span>
            <span class="s2">&quot;specified in the AWS documentation. If not provided, a default value of &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ECS_DEFAULT_CPU</span><span class="si">}</span><span class="s2"> will be used unless present on the task definition.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">memory</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The amount of memory to provide to the ECS task. Valid amounts are &quot;</span>
            <span class="s2">&quot;specified in the AWS documentation. If not provided, a default value of &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ECS_DEFAULT_MEMORY</span><span class="si">}</span><span class="s2"> will be used unless present on the task definition.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">execution_role_arn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Execution Role ARN&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;An execution role to use for the task. This controls the permissions of &quot;</span>
            <span class="s2">&quot;the task when it is launching. If this value is not null, it will &quot;</span>
            <span class="s2">&quot;override the value in the task definition. An execution role must be &quot;</span>
            <span class="s2">&quot;provided to capture logs from the container.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">configure_cloudwatch_logs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If `True`, the Prefect container will be configured to send its output &quot;</span>
            <span class="s2">&quot;to the AWS CloudWatch logs service. This functionality requires an &quot;</span>
            <span class="s2">&quot;execution role with logs:CreateLogStream, logs:CreateLogGroup, and &quot;</span>
            <span class="s2">&quot;logs:PutLogEvents permissions. The default for this field is `False` &quot;</span>
            <span class="s2">&quot;unless `stream_output` is set. &quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">cloudwatch_logs_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;When `configure_cloudwatch_logs` is enabled, this setting may be used to &quot;</span>
            <span class="s2">&quot;pass additional options to the CloudWatch logs configuration or override &quot;</span>
            <span class="s2">&quot;the default options. See the AWS documentation for available options. &quot;</span>
            <span class="s2">&quot;https://docs.aws.amazon.com/AmazonECS/latest/developerguide/using_awslogs.html#create_awslogs_logdriver_options&quot;</span>  <span class="c1"># noqa</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">stream_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If `True`, logs will be streamed from the Prefect container to the local &quot;</span>
            <span class="s2">&quot;console. Unless you have configured AWS CloudWatch logs manually on your &quot;</span>
            <span class="s2">&quot;task definition, this requires the same prerequisites outlined in &quot;</span>
            <span class="s2">&quot;`configure_cloudwatch_logs`.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Task run settings</span>
    <span class="n">launch_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;FARGATE&quot;</span><span class="p">,</span> <span class="s2">&quot;EC2&quot;</span><span class="p">,</span> <span class="s2">&quot;EXTERNAL&quot;</span><span class="p">,</span> <span class="s2">&quot;FARGATE_SPOT&quot;</span><span class="p">]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;FARGATE&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The type of ECS task run infrastructure that should be used. Note that &quot;</span>
            <span class="s2">&quot;&#39;FARGATE_SPOT&#39; is not a formal ECS launch type, but we will configure the &quot;</span>
            <span class="s2">&quot;proper capacity provider stategy if set here.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">vpc_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;VPC ID&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The AWS VPC to link the task run to. This is only applicable when using &quot;</span>
            <span class="s2">&quot;the &#39;awsvpc&#39; network mode for your task. FARGATE tasks require this &quot;</span>
            <span class="s2">&quot;network  mode, but for EC2 tasks the default network mode is &#39;bridge&#39;. &quot;</span>
            <span class="s2">&quot;If using the &#39;awsvpc&#39; network mode and this field is null, your default &quot;</span>
            <span class="s2">&quot;VPC will be used. If no default VPC can be found, the task run will fail.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">cluster</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The ECS cluster to run the task in. The ARN or name may be provided. If &quot;</span>
            <span class="s2">&quot;not provided, the default cluster will be used.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Environment Variables&quot;</span><span class="p">,</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Environment variables to provide to the task run. These variables are set &quot;</span>
            <span class="s2">&quot;on the Prefect container at task runtime. These will not be set on the &quot;</span>
            <span class="s2">&quot;task definition.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">task_role_arn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Task Role ARN&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;A role to attach to the task run. This controls the permissions of the &quot;</span>
            <span class="s2">&quot;task while it is running.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">task_customizations</span><span class="p">:</span> <span class="n">JsonPatch</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">JsonPatch</span><span class="p">([]),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A list of JSON 6902 patches to apply to the task run request.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Execution settings</span>
    <span class="n">task_start_timeout_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The amount of time to watch for the start of the ECS task &quot;</span>
            <span class="s2">&quot;before marking it as failed. The task must enter a RUNNING state to be &quot;</span>
            <span class="s2">&quot;considered started.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">task_watch_poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The amount of time to wait between AWS API calls while monitoring the &quot;</span>
            <span class="s2">&quot;state of an ECS task.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@root_validator</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_default_configure_cloudwatch_logs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Streaming output generally requires CloudWatch logs to be configured.</span>

<span class="sd">        To avoid entangled arguments in the simple case, `configure_cloudwatch_logs`</span>
<span class="sd">        defaults to matching the value of `stream_output`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">configure_cloudwatch_logs</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;configure_cloudwatch_logs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">configure_cloudwatch_logs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="s2">&quot;configure_cloudwatch_logs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stream_output&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="nd">@root_validator</span>
    <span class="k">def</span> <span class="nf">configure_cloudwatch_logs_requires_execution_role_arn</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enforces that an execution role arn is provided (or could be provided by a</span>
<span class="sd">        runtime task definition) when configuring logging.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;configure_cloudwatch_logs&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;execution_role_arn&quot;</span><span class="p">)</span>
            <span class="c1"># Do not raise if they&#39;ve linked to another task definition or provided</span>
            <span class="c1"># it without using our shortcuts</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_definition_arn&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_definition&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;executionRoleArn&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;An `execution_role_arn` must be provided to use &quot;</span>
                <span class="s2">&quot;`configure_cloudwatch_logs` or `stream_logs`.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="nd">@root_validator</span>
    <span class="k">def</span> <span class="nf">cloudwatch_logs_options_requires_configure_cloudwatch_logs</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enforces that an execution role arn is provided (or could be provided by a</span>
<span class="sd">        runtime task definition) when configuring logging.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cloudwatch_logs_options&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;configure_cloudwatch_logs&quot;</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`configure_cloudwatch_log` must be enabled to use &quot;</span>
                <span class="s2">&quot;`cloudwatch_logs_options`.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="nd">@root_validator</span>
    <span class="k">def</span> <span class="nf">image_is_required</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enforces that an image is available if the user sets it to `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_definition_arn&quot;</span><span class="p">)</span>
            <span class="c1"># Check for an image in the task definition; whew!</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">get_prefect_container</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_definition&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;containerDefinitions&quot;</span><span class="p">,</span> <span class="p">[]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="ow">or</span> <span class="p">{}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;A value for the `image` field must be provided unless already &quot;</span>
                <span class="s2">&quot;present for the Prefect container definition a given task definition.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;task_customizations&quot;</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">cast_customizations_to_a_json_patch</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">JsonPatch</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JsonPatch</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonPatch</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="c1"># Support serialization of the &#39;JsonPatch&#39; type</span>
        <span class="n">arbitrary_types_allowed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">json_encoders</span> <span class="o">=</span> <span class="p">{</span><span class="n">JsonPatch</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">patch</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="c1"># Support serialization of the &#39;JsonPatch&#39; type</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;task_customizations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_customizations</span><span class="o">.</span><span class="n">patch</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@sync_compatible</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TaskStatus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ECSTaskResult</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the configured task on ECS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">boto_session</span><span class="p">,</span> <span class="n">ecs_client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_sync_in_worker_thread</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_session_and_client</span>
        <span class="p">)</span>

        <span class="p">(</span>
            <span class="n">task_arn</span><span class="p">,</span>
            <span class="n">cluster_arn</span><span class="p">,</span>
            <span class="n">task_definition</span><span class="p">,</span>
            <span class="n">is_new_task_definition</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_sync_in_worker_thread</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_task_and_wait_for_start</span><span class="p">,</span> <span class="n">boto_session</span><span class="p">,</span> <span class="n">ecs_client</span>
        <span class="p">)</span>

        <span class="c1"># Display a nice message indicating the command and image</span>
        <span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="ow">or</span> <span class="n">get_prefect_container</span><span class="p">(</span>
            <span class="n">task_definition</span><span class="p">[</span><span class="s2">&quot;containerDefinitions&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Running command </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="si">!r}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;in container </span><span class="si">{</span><span class="n">PREFECT_ECS_CONTAINER_NAME</span><span class="si">!r}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="si">}</span><span class="s2">)...&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">task_status</span><span class="p">:</span>
            <span class="n">task_status</span><span class="o">.</span><span class="n">started</span><span class="p">(</span><span class="n">task_arn</span><span class="p">)</span>

        <span class="n">status_code</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_sync_in_worker_thread</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_watch_task_and_get_exit_code</span><span class="p">,</span>
            <span class="n">task_arn</span><span class="p">,</span>
            <span class="n">cluster_arn</span><span class="p">,</span>
            <span class="n">task_definition</span><span class="p">,</span>
            <span class="n">is_new_task_definition</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_deregister_task_definition</span><span class="p">,</span>
            <span class="n">boto_session</span><span class="p">,</span>
            <span class="n">ecs_client</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ECSTaskResult</span><span class="p">(</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">task_arn</span><span class="p">,</span>
            <span class="c1"># If the container does not start the exit code can be null but we must</span>
            <span class="c1"># still report a status code. We use a -1 to indicate a special code.</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_log_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal property for generating a prefix for logs where `name` may be null</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ECSTask </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;ECSTask&quot;</span>

    <span class="k">def</span> <span class="nf">_get_session_and_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">_ECSClient</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a boto3 session and ECS client</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">boto_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aws_credentials</span><span class="o">.</span><span class="n">get_boto3_session</span><span class="p">()</span>
        <span class="n">ecs_client</span> <span class="o">=</span> <span class="n">boto_session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;ecs&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">boto_session</span><span class="p">,</span> <span class="n">ecs_client</span>

    <span class="k">def</span> <span class="nf">_create_task_and_wait_for_start</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">boto_session</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">ecs_client</span><span class="p">:</span> <span class="n">_ECSClient</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register the task definition, create the task run, and wait for it to start.</span>

<span class="sd">        Returns a tuple of</span>
<span class="sd">        - The task ARN</span>
<span class="sd">        - The task&#39;s cluster ARN</span>
<span class="sd">        - The task definition</span>
<span class="sd">        - A bool indicating if the task definition is newly registered</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_task_definition_registered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">requested_task_definition</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_task_definition</span><span class="p">(</span><span class="n">ecs_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_definition_arn</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_definition_arn</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_definition</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">task_definition_arn</span> <span class="o">=</span> <span class="n">requested_task_definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;taskDefinitionArn&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">task_definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_task_definition</span><span class="p">(</span>
            <span class="n">requested_task_definition</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">ecs_client</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">region_name</span>
        <span class="p">)</span>

        <span class="c1"># We must register the task definition if the arn is null or changes were made</span>
        <span class="k">if</span> <span class="n">task_definition</span> <span class="o">!=</span> <span class="n">requested_task_definition</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">task_definition_arn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Registering task definition...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Task definition payload</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">task_definition</span><span class="p">))</span>
            <span class="n">task_definition_arn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_task_definition</span><span class="p">(</span>
                <span class="n">ecs_client</span><span class="p">,</span> <span class="n">task_definition</span>
            <span class="p">)</span>
            <span class="n">new_task_definition_registered</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">task_definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;networkMode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;awsvpc&quot;</span><span class="p">:</span>
            <span class="n">network_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_vpc_network_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">,</span> <span class="n">boto_session</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">network_config</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">task_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_task_run</span><span class="p">(</span>
            <span class="n">network_config</span><span class="o">=</span><span class="n">network_config</span><span class="p">,</span>
            <span class="n">task_definition_arn</span><span class="o">=</span><span class="n">task_definition_arn</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Creating task run...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Task run payload</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">task_run</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_task</span><span class="p">(</span><span class="n">ecs_client</span><span class="p">,</span> <span class="n">task_run</span><span class="p">)</span>
            <span class="n">task_arn</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;taskArn&quot;</span><span class="p">]</span>
            <span class="n">cluster_arn</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;clusterArn&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_report_task_run_creation_failure</span><span class="p">(</span><span class="n">task_run</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

        <span class="c1"># Raises an exception if the task does not start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Waiting for task run to start...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_task_start</span><span class="p">(</span>
            <span class="n">task_arn</span><span class="p">,</span> <span class="n">cluster_arn</span><span class="p">,</span> <span class="n">ecs_client</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_start_timeout_seconds</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">task_arn</span><span class="p">,</span> <span class="n">cluster_arn</span><span class="p">,</span> <span class="n">task_definition</span><span class="p">,</span> <span class="n">new_task_definition_registered</span>

    <span class="k">def</span> <span class="nf">_watch_task_and_get_exit_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cluster_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">task_definition</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">deregister_task_definition</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">boto_session</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span>
        <span class="n">ecs_client</span><span class="p">:</span> <span class="n">_ECSClient</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for the task run to complete and retrieve the exit code of the Prefect</span>
<span class="sd">        container.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Wait for completion and stream logs</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_task_finish</span><span class="p">(</span>
            <span class="n">task_arn</span><span class="p">,</span> <span class="n">cluster_arn</span><span class="p">,</span> <span class="n">task_definition</span><span class="p">,</span> <span class="n">ecs_client</span><span class="p">,</span> <span class="n">boto_session</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">deregister_task_definition</span><span class="p">:</span>
            <span class="n">ecs_client</span><span class="o">.</span><span class="n">deregister_task_definition</span><span class="p">(</span>
                <span class="n">taskDefinition</span><span class="o">=</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;taskDefinitionArn&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Check the status code of the Prefect container</span>
        <span class="n">prefect_container</span> <span class="o">=</span> <span class="n">get_prefect_container</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;containers&quot;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">prefect_container</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;&#39;prefect&#39; container missing from task: </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="n">prefect_container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exitCode&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_report_container_status_code</span><span class="p">(</span><span class="n">PREFECT_ECS_CONTAINER_NAME</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">status_code</span>

    <span class="k">def</span> <span class="nf">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a preview of the task definition and task run that will be sent to AWS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">preview</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">task_definition_arn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_definition_arn</span> <span class="ow">or</span> <span class="s2">&quot;&lt;registered at runtime&gt;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_definition</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_definition_arn</span><span class="p">:</span>
            <span class="n">task_definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_task_definition</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">task_definition</span> <span class="ow">or</span> <span class="p">{},</span>
                <span class="n">region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aws_credentials</span><span class="o">.</span><span class="n">region_name</span>
                <span class="ow">or</span> <span class="s2">&quot;&lt;loaded from client at runtime&gt;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">preview</span> <span class="o">+=</span> <span class="s2">&quot;---</span><span class="se">\n</span><span class="s2"># Task definition</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">preview</span> <span class="o">+=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">task_definition</span><span class="p">)</span>
            <span class="n">preview</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">task_definition</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">task_definition</span> <span class="ow">and</span> <span class="n">task_definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;networkMode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;awsvpc&quot;</span><span class="p">:</span>
            <span class="n">vpc</span> <span class="o">=</span> <span class="s2">&quot;the default VPC&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span>
            <span class="n">network_config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;awsvpcConfiguration&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;subnets&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;loaded from </span><span class="si">{</span><span class="n">vpc</span><span class="si">}</span><span class="s2"> at runtime&gt;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;assignPublicIp&quot;</span><span class="p">:</span> <span class="s2">&quot;ENABLED&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">network_config</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">task_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_task_run</span><span class="p">(</span><span class="n">network_config</span><span class="p">,</span> <span class="n">task_definition_arn</span><span class="p">)</span>
        <span class="n">preview</span> <span class="o">+=</span> <span class="s2">&quot;---</span><span class="se">\n</span><span class="s2"># Task run request</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">preview</span> <span class="o">+=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">task_run</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">preview</span>

    <span class="k">def</span> <span class="nf">_report_container_status_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a log for the given container status code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">status_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Task exited without reporting an exit status &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;for container </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Container </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> exited successfully.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Container </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> exited with non-zero exit &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;code </span><span class="si">{</span><span class="n">status_code</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_report_task_run_creation_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_run</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap common AWS task run creation failures with nicer user-facing messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># AWS generates exception types at runtime so they must be captured a bit</span>
        <span class="c1"># differently than normal.</span>
        <span class="k">if</span> <span class="s2">&quot;ClusterNotFoundException&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="n">task_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to run ECS task, cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">!r}</span><span class="s2"> not found. &quot;</span>
                <span class="s2">&quot;Confirm that the cluster is configured in your region.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
        <span class="k">elif</span> <span class="s2">&quot;No Container Instances&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_type</span> <span class="o">==</span> <span class="s2">&quot;EC2&quot;</span><span class="p">:</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="n">task_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to run ECS task, cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">!r}</span><span class="s2"> does not appear to &quot;</span>
                <span class="s2">&quot;have any container instances associated with it. Confirm that you &quot;</span>
                <span class="s2">&quot;have EC2 container instances available.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="s2">&quot;failed to validate logger args&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="ow">and</span> <span class="s2">&quot;AccessDeniedException&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_cloudwatch_logs</span>
        <span class="p">):</span>

            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to run ECS task, the attached execution role does not appear &quot;</span>
                <span class="s2">&quot;to have sufficient permissions. Ensure that the execution role &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_role</span><span class="si">!r}</span><span class="s2"> has permissions logs:CreateLogStream, &quot;</span>
                <span class="s2">&quot;logs:CreateLogGroup, and logs:PutLogEvents.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_watch_task_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cluster_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ecs_client</span><span class="p">:</span> <span class="n">_ECSClient</span><span class="p">,</span>
        <span class="n">current_status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;UNKNOWN&quot;</span><span class="p">,</span>
        <span class="n">until_status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Watches an ECS task run by querying every `poll_interval` seconds. After each</span>
<span class="sd">        query, the retrieved task is yielded. This function returns when the task run</span>
<span class="sd">        reaches a STOPPED status or the provided `until_status`.</span>

<span class="sd">        Emits a log each time the status changes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">last_status</span> <span class="o">=</span> <span class="n">status</span> <span class="o">=</span> <span class="n">current_status</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">until_status</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">ecs_client</span><span class="o">.</span><span class="n">describe_tasks</span><span class="p">(</span><span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="n">task_arn</span><span class="p">],</span> <span class="n">cluster</span><span class="o">=</span><span class="n">cluster_arn</span><span class="p">)[</span>
                <span class="s2">&quot;tasks&quot;</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;lastStatus&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">last_status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Status is </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="k">yield</span> <span class="n">task</span>

            <span class="c1"># No point in continuing if the status is final</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;STOPPED&quot;</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">last_status</span> <span class="o">=</span> <span class="n">status</span>
            <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">elapsed_time</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Timed out after </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">}</span><span class="s2">s while watching task for status &quot;</span>
                    <span class="s2">&quot;{until_status or &#39;STOPPED&#39;}&quot;</span>
                <span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_watch_poll_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_wait_for_task_start</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">task_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cluster_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ecs_client</span><span class="p">:</span> <span class="n">_ECSClient</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits for an ECS task run to reach a RUNNING status.</span>

<span class="sd">        If a STOPPED status is reached instead, an exception is raised indicating the</span>
<span class="sd">        reason that the task run did not start.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_watch_task_run</span><span class="p">(</span>
            <span class="n">task_arn</span><span class="p">,</span> <span class="n">cluster_arn</span><span class="p">,</span> <span class="n">ecs_client</span><span class="p">,</span> <span class="n">until_status</span><span class="o">=</span><span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
        <span class="p">):</span>
            <span class="c1"># TODO: It is possible that the task has passed _through_ a RUNNING</span>
            <span class="c1">#       status during the polling interval. In this case, there is not an</span>
            <span class="c1">#       exception to raise.</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;lastStatus&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STOPPED&quot;</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stopCode&quot;</span><span class="p">)</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stoppedReason&quot;</span><span class="p">)</span>
                <span class="c1"># Generate a dynamic exception type from the AWS name</span>
                <span class="k">raise</span> <span class="nb">type</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,),</span> <span class="p">{})(</span><span class="n">reason</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">task</span>

    <span class="k">def</span> <span class="nf">_wait_for_task_finish</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cluster_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">task_definition</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">ecs_client</span><span class="p">:</span> <span class="n">_ECSClient</span><span class="p">,</span>
        <span class="n">boto_session</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Watch an ECS task until it reaches a STOPPED status.</span>

<span class="sd">        If configured, logs from the Prefect container are streamed to stderr.</span>

<span class="sd">        Returns a description of the task on completion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">can_stream_output</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_output</span><span class="p">:</span>
            <span class="n">container_def</span> <span class="o">=</span> <span class="n">get_prefect_container</span><span class="p">(</span>
                <span class="n">task_definition</span><span class="p">[</span><span class="s2">&quot;containerDefinitions&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">container_def</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Prefect container definition not found in &quot;</span>
                    <span class="s2">&quot;task definition. Output cannot be streamed.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">container_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;logConfiguration&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Logging configuration not found on task. &quot;</span>
                    <span class="s2">&quot;Output cannot be streamed.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">container_def</span><span class="p">[</span><span class="s2">&quot;logConfiguration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;logDriver&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;awslogs&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Logging configuration uses unsupported &quot;</span>
                    <span class="s2">&quot; driver {container_def[&#39;logConfiguration&#39;].get(&#39;logDriver&#39;)!r}. &quot;</span>
                    <span class="s2">&quot;Output cannot be streamed.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Prepare to stream the output</span>
                <span class="n">log_config</span> <span class="o">=</span> <span class="n">container_def</span><span class="p">[</span><span class="s2">&quot;logConfiguration&quot;</span><span class="p">][</span><span class="s2">&quot;options&quot;</span><span class="p">]</span>
                <span class="n">logs_client</span> <span class="o">=</span> <span class="n">boto_session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">)</span>
                <span class="n">can_stream_output</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Track the last log timestamp to prevent double display</span>
                <span class="n">last_log_timestamp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># Determine the name of the stream as &quot;prefix/family/run&quot;</span>
                <span class="n">stream_name</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">log_config</span><span class="p">[</span><span class="s2">&quot;awslogs-stream-prefix&quot;</span><span class="p">],</span>
                        <span class="n">task_definition</span><span class="p">[</span><span class="s2">&quot;family&quot;</span><span class="p">],</span>
                        <span class="n">task_arn</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Streaming output from container &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PREFECT_ECS_CONTAINER_NAME</span><span class="si">!r}</span><span class="s2">...&quot;</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_watch_task_run</span><span class="p">(</span>
            <span class="n">task_arn</span><span class="p">,</span> <span class="n">cluster_arn</span><span class="p">,</span> <span class="n">ecs_client</span><span class="p">,</span> <span class="n">current_status</span><span class="o">=</span><span class="s2">&quot;RUNNING&quot;</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_output</span> <span class="ow">and</span> <span class="n">can_stream_output</span><span class="p">:</span>
                <span class="c1"># On each poll for task run status, also retrieve available logs</span>
                <span class="n">last_log_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream_available_logs</span><span class="p">(</span>
                    <span class="n">logs_client</span><span class="p">,</span>
                    <span class="n">log_group</span><span class="o">=</span><span class="n">log_config</span><span class="p">[</span><span class="s2">&quot;awslogs-group&quot;</span><span class="p">],</span>
                    <span class="n">log_stream</span><span class="o">=</span><span class="n">stream_name</span><span class="p">,</span>
                    <span class="n">last_log_timestamp</span><span class="o">=</span><span class="n">last_log_timestamp</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">task</span>

    <span class="k">def</span> <span class="nf">_stream_available_logs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">logs_client</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">log_group</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">log_stream</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">last_log_timestamp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stream logs from the given log group and stream since the last log timestamp.</span>

<span class="sd">        Will continue on paginated responses until all logs are returned.</span>

<span class="sd">        Returns the last log timestamp which can be used to call this method in the</span>
<span class="sd">        future.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">last_log_stream_token</span> <span class="o">=</span> <span class="s2">&quot;NO-TOKEN&quot;</span>
        <span class="n">next_log_stream_token</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># AWS will return the same token that we send once the end of the paginated</span>
        <span class="c1"># response is reached</span>
        <span class="k">while</span> <span class="n">last_log_stream_token</span> <span class="o">!=</span> <span class="n">next_log_stream_token</span><span class="p">:</span>
            <span class="n">last_log_stream_token</span> <span class="o">=</span> <span class="n">next_log_stream_token</span>

            <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;logGroupName&quot;</span><span class="p">:</span> <span class="n">log_group</span><span class="p">,</span>
                <span class="s2">&quot;logStreamName&quot;</span><span class="p">:</span> <span class="n">log_stream</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">last_log_stream_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">request</span><span class="p">[</span><span class="s2">&quot;nextToken&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_log_stream_token</span>

            <span class="k">if</span> <span class="n">last_log_timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Bump the timestamp by one ms to avoid retrieving the last log again</span>
                <span class="n">request</span><span class="p">[</span><span class="s2">&quot;startTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_log_timestamp</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">logs_client</span><span class="o">.</span><span class="n">get_log_events</span><span class="p">(</span><span class="o">**</span><span class="n">request</span><span class="p">)</span>

            <span class="n">log_events</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">log_event</span> <span class="ow">in</span> <span class="n">log_events</span><span class="p">:</span>
                <span class="c1"># TODO: This doesn&#39;t forward to the local logger, which can be</span>
                <span class="c1">#       bad for customizing handling and understanding where the</span>
                <span class="c1">#       log is coming from, but it avoid nesting logger information</span>
                <span class="c1">#       when the content is output from a Prefect logger on the</span>
                <span class="c1">#       running infrastructure</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">log_event</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">last_log_timestamp</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">or</span> <span class="n">log_event</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">last_log_timestamp</span>
                <span class="p">):</span>
                    <span class="n">last_log_timestamp</span> <span class="o">=</span> <span class="n">log_event</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>

            <span class="n">next_log_stream_token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nextForwardToken&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">last_log_timestamp</span>

    <span class="k">def</span> <span class="nf">_retrieve_task_definition</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ecs_client</span><span class="p">:</span> <span class="n">_ECSClient</span><span class="p">,</span> <span class="n">task_definition_arn</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve an existing task definition from AWS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Retrieving task definition </span><span class="si">{</span><span class="n">task_definition_arn</span><span class="si">!r}</span><span class="s2">...&quot;</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ecs_client</span><span class="o">.</span><span class="n">describe_task_definition</span><span class="p">(</span>
            <span class="n">taskDefinition</span><span class="o">=</span><span class="n">task_definition_arn</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;taskDefinition&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_register_task_definition</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ecs_client</span><span class="p">:</span> <span class="n">_ECSClient</span><span class="p">,</span> <span class="n">task_definition</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a new task definition with AWS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Consider including a global cache for this task definition since</span>
        <span class="c1">#       registration of task definitions is frequently rate limited</span>
        <span class="n">task_definition_request</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">task_definition</span><span class="p">)</span>

        <span class="c1"># We need to remove some fields here if copying an existing task definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_definition_arn</span><span class="p">:</span>
            <span class="n">task_definition_request</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;compatibilities&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">task_definition_request</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;taskDefinitionArn&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">task_definition_request</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;revision&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">task_definition_request</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">task_definition_request</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;requiresAttributes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">task_definition_request</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;registeredAt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">task_definition_request</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;registeredBy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">ecs_client</span><span class="o">.</span><span class="n">register_task_definition</span><span class="p">(</span><span class="o">**</span><span class="n">task_definition_request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;taskDefinition&quot;</span><span class="p">][</span><span class="s2">&quot;taskDefinitionArn&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_prepare_task_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_definition</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare a task definition by inferring any defaults and merging overrides.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task_definition</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">task_definition</span><span class="p">)</span>

        <span class="c1"># Configure the Prefect runtime container</span>
        <span class="n">task_definition</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;containerDefinitions&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">container</span> <span class="o">=</span> <span class="n">get_prefect_container</span><span class="p">(</span><span class="n">task_definition</span><span class="p">[</span><span class="s2">&quot;containerDefinitions&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">container</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">container</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">PREFECT_ECS_CONTAINER_NAME</span><span class="p">}</span>
            <span class="n">task_definition</span><span class="p">[</span><span class="s2">&quot;containerDefinitions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">:</span>
            <span class="n">container</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>

        <span class="c1"># Remove any keys that have been explicitly &quot;unset&quot;</span>
        <span class="n">unset_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;environment&quot;</span><span class="p">,</span> <span class="p">[])):</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">unset_keys</span><span class="p">:</span>
                <span class="n">container</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_cloudwatch_logs</span><span class="p">:</span>
            <span class="n">container</span><span class="p">[</span><span class="s2">&quot;logConfiguration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;logDriver&quot;</span><span class="p">:</span> <span class="s2">&quot;awslogs&quot;</span><span class="p">,</span>
                <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;awslogs-create-group&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;awslogs-group&quot;</span><span class="p">:</span> <span class="s2">&quot;prefect&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;awslogs-region&quot;</span><span class="p">:</span> <span class="n">region</span><span class="p">,</span>
                    <span class="s2">&quot;awslogs-stream-prefix&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;prefect&quot;</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">cloudwatch_logs_options</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>

        <span class="n">task_definition</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;family&quot;</span><span class="p">,</span> <span class="s2">&quot;prefect&quot;</span><span class="p">)</span>

        <span class="c1"># CPU and memory are required in some cases, retrieve the value to use</span>
        <span class="n">cpu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu</span> <span class="ow">or</span> <span class="n">task_definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ECS_DEFAULT_CPU</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="ow">or</span> <span class="n">task_definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ECS_DEFAULT_MEMORY</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_type</span> <span class="o">==</span> <span class="s2">&quot;FARGATE&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_type</span> <span class="o">==</span> <span class="s2">&quot;FARGATE_SPOT&quot;</span><span class="p">:</span>
            <span class="c1"># Task level memory and cpu are required when using fargate</span>
            <span class="n">task_definition</span><span class="p">[</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span>
            <span class="n">task_definition</span><span class="p">[</span><span class="s2">&quot;memory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span>

            <span class="c1"># The FARGATE compatibility is required if it will be used as as launch type</span>
            <span class="n">requires_compatibilities</span> <span class="o">=</span> <span class="n">task_definition</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                <span class="s2">&quot;requiresCompatibilities&quot;</span><span class="p">,</span> <span class="p">[]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;FARGATE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">requires_compatibilities</span><span class="p">:</span>
                <span class="n">task_definition</span><span class="p">[</span><span class="s2">&quot;requiresCompatibilities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;FARGATE&quot;</span><span class="p">)</span>

            <span class="c1"># Only the &#39;awsvpc&#39; network mode is supported when using FARGATE</span>
            <span class="c1"># However, we will not enforce that here if the user has set it</span>
            <span class="n">network_mode</span> <span class="o">=</span> <span class="n">task_definition</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;networkMode&quot;</span><span class="p">,</span> <span class="s2">&quot;awsvpc&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">network_mode</span> <span class="o">!=</span> <span class="s2">&quot;awsvpc&quot;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Found network mode </span><span class="si">{</span><span class="n">network_mode</span><span class="si">!r}</span><span class="s2"> which is not compatible with &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;launch type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">launch_type</span><span class="si">!r}</span><span class="s2">. Use either the &#39;EC2&#39; launch &quot;</span>
                    <span class="s2">&quot;type or the &#39;awsvpc&#39; network mode.&quot;</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_type</span> <span class="o">==</span> <span class="s2">&quot;EC2&quot;</span><span class="p">:</span>
            <span class="c1"># Container level memory and cpu are required when using ec2</span>
            <span class="n">container</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span>
            <span class="n">container</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">memory</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_role_arn</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_definition_arn</span><span class="p">:</span>
            <span class="n">task_definition</span><span class="p">[</span><span class="s2">&quot;executionRoleArn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_role_arn</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_cloudwatch_logs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;executionRoleArn&quot;</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;An execution role arn must be set on the task definition to use &quot;</span>
                <span class="s2">&quot;`configure_cloudwatch_logs` or `stream_logs` but no execution role &quot;</span>
                <span class="s2">&quot;was found on the task definition.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">task_definition</span>

    <span class="k">def</span> <span class="nf">_prepare_task_run_overrides</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the &#39;overrides&#39; payload for a task run request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">overrides</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;containerOverrides&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">PREFECT_ECS_CONTAINER_NAME</span><span class="p">,</span>
                    <span class="s2">&quot;environment&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">{</span>
                            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_environment</span><span class="p">(),</span>
                            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
                        <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="p">],</span>
                <span class="p">}</span>
            <span class="p">],</span>
        <span class="p">}</span>

        <span class="n">prefect_container_overrides</span> <span class="o">=</span> <span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;containerOverrides&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">:</span>
            <span class="n">prefect_container_overrides</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_role_arn</span><span class="p">:</span>
            <span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;executionRoleArn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_role_arn</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_role_arn</span><span class="p">:</span>
            <span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;taskRoleArn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_role_arn</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span>
            <span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;memory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
            <span class="n">prefect_container_overrides</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu</span><span class="p">:</span>
            <span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu</span><span class="p">)</span>
            <span class="n">prefect_container_overrides</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">overrides</span>

    <span class="k">def</span> <span class="nf">_load_vpc_network_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">vpc_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">boto_session</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load settings from a specific VPC or the default VPC and generate a task</span>
<span class="sd">        run request&#39;s network configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ec2_client</span> <span class="o">=</span> <span class="n">boto_session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;ec2&quot;</span><span class="p">)</span>
        <span class="n">vpc_message</span> <span class="o">=</span> <span class="s2">&quot;the default VPC&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">vpc_id</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;VPC with ID </span><span class="si">{</span><span class="n">vpc_id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vpc_id</span><span class="p">:</span>
            <span class="c1"># Retrieve the default VPC</span>
            <span class="n">describe</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Filters&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;isDefault&quot;</span><span class="p">,</span> <span class="s2">&quot;Values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">]}]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">describe</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;VpcIds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">vpc_id</span><span class="p">]}</span>

        <span class="n">vpcs</span> <span class="o">=</span> <span class="n">ec2_client</span><span class="o">.</span><span class="n">describe_vpcs</span><span class="p">(</span><span class="o">**</span><span class="n">describe</span><span class="p">)[</span><span class="s2">&quot;Vpcs&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vpcs</span><span class="p">:</span>
            <span class="n">help_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Pass an explicit `vpc_id` or configure a default VPC.&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">vpc_id</span>
                <span class="k">else</span> <span class="s2">&quot;Check that the VPC exists in the current region.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to find </span><span class="si">{</span><span class="n">vpc_message</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Network configuration cannot be inferred. &quot;</span> <span class="o">+</span> <span class="n">help_message</span>
            <span class="p">)</span>

        <span class="n">vpc_id</span> <span class="o">=</span> <span class="n">vpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;VpcId&quot;</span><span class="p">]</span>
        <span class="n">subnets</span> <span class="o">=</span> <span class="n">ec2_client</span><span class="o">.</span><span class="n">describe_subnets</span><span class="p">(</span>
            <span class="n">Filters</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;vpc-id&quot;</span><span class="p">,</span> <span class="s2">&quot;Values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">vpc_id</span><span class="p">]}]</span>
        <span class="p">)[</span><span class="s2">&quot;Subnets&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subnets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to find subnets for </span><span class="si">{</span><span class="n">vpc_message</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Network configuration cannot be inferred.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;awsvpcConfiguration&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;subnets&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;SubnetId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subnets</span><span class="p">],</span>
                <span class="s2">&quot;assignPublicIp&quot;</span><span class="p">:</span> <span class="s2">&quot;ENABLED&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_prepare_task_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">network_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
        <span class="n">task_definition_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare a task run request payload.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task_run</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;overrides&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_task_run_overrides</span><span class="p">(),</span>
            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">],</span>
            <span class="s2">&quot;taskDefinition&quot;</span><span class="p">:</span> <span class="n">task_definition_arn</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
            <span class="n">task_run</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_type</span> <span class="o">==</span> <span class="s2">&quot;FARGATE_SPOT&quot;</span><span class="p">:</span>
                <span class="n">task_run</span><span class="p">[</span><span class="s2">&quot;capacityProviderStrategy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;capacityProvider&quot;</span><span class="p">:</span> <span class="s2">&quot;FARGATE_SPOT&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">task_run</span><span class="p">[</span><span class="s2">&quot;launchType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_type</span>

        <span class="k">if</span> <span class="n">network_config</span><span class="p">:</span>
            <span class="n">task_run</span><span class="p">[</span><span class="s2">&quot;networkConfiguration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network_config</span>

        <span class="n">task_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_customizations</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">task_run</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">task_run</span>

    <span class="k">def</span> <span class="nf">_run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ecs_client</span><span class="p">:</span> <span class="n">_ECSClient</span><span class="p">,</span> <span class="n">task_run</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the task using the ECS client.</span>

<span class="sd">        This is isolated as a separate method for testing purposes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ecs_client</span><span class="o">.</span><span class="n">run_task</span><span class="p">(</span><span class="o">**</span><span class="n">task_run</span><span class="p">)[</span><span class="s2">&quot;tasks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">




<h4 id="prefect_aws.ecs.ECSTask-attributes">Attributes</h4>


  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.auto_deregister_task_definition" class="doc doc-heading">
<code class="highlight language-python"><span class="n">auto_deregister_task_definition</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>If set, any task definitions that are created by this block will be deregistered. Existing task definitions linked by ARN will never be deregistered. Deregistering a task definition does not remove it from your AWS account, instead it will be marked as INACTIVE.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.aws_credentials" class="doc doc-heading">
<code class="highlight language-python"><span class="n">aws_credentials</span><span class="p">:</span> <span class="n">AwsCredentials</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>The AWS credentials to use to connect to ECS.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.cloudwatch_logs_options" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cloudwatch_logs_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>When <code>configure_cloudwatch_logs</code> is enabled, this setting may be used to pass additional options to the CloudWatch logs configuration or override the default options. See the AWS documentation for available options. https://docs.aws.amazon.com/AmazonECS/latest/developerguide/using_awslogs.html#create_awslogs_logdriver_options</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.cluster" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cluster</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>The ECS cluster to run the task in. The ARN or name may be provided. If not provided, the default cluster will be used.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.configure_cloudwatch_logs" class="doc doc-heading">
<code class="highlight language-python"><span class="n">configure_cloudwatch_logs</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>If <code>True</code>, the Prefect container will be configured to send its output to the AWS CloudWatch logs service. This functionality requires an execution role with logs:CreateLogStream, logs:CreateLogGroup, and logs:PutLogEvents permissions. The default for this field is <code>False</code> unless <code>stream_output</code> is set. </p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.cpu" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cpu</span><span class="p">:</span> <span class="nb">int</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>The amount of CPU to provide to the ECS task. Valid amounts are specified in the AWS documentation. If not provided, a default value of 1024 will be used unless present on the task definition.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.execution_role_arn" class="doc doc-heading">
<code class="highlight language-python"><span class="n">execution_role_arn</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>An execution role to use for the task. This controls the permissions of the task when it is launching. If this value is not null, it will override the value in the task definition. An execution role must be provided to capture logs from the container.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.image" class="doc doc-heading">
<code class="highlight language-python"><span class="n">image</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>The image to use for the Prefect container in the task. If this value is not null, it will override the value in the task definition. This value defaults to a Prefect base image matching your local versions.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.launch_type" class="doc doc-heading">
<code class="highlight language-python"><span class="n">launch_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;FARGATE&#39;</span><span class="p">,</span> <span class="s1">&#39;EC2&#39;</span><span class="p">,</span> <span class="s1">&#39;EXTERNAL&#39;</span><span class="p">,</span> <span class="s1">&#39;FARGATE_SPOT&#39;</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>The type of ECS task run infrastructure that should be used. Note that 'FARGATE_SPOT' is not a formal ECS launch type, but we will configure the proper capacity provider stategy if set here.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.memory" class="doc doc-heading">
<code class="highlight language-python"><span class="n">memory</span><span class="p">:</span> <span class="nb">int</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>The amount of memory to provide to the ECS task. Valid amounts are specified in the AWS documentation. If not provided, a default value of 2048 will be used unless present on the task definition.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.stream_output" class="doc doc-heading">
<code class="highlight language-python"><span class="n">stream_output</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>If <code>True</code>, logs will be streamed from the Prefect container to the local console. Unless you have configured AWS CloudWatch logs manually on your task definition, this requires the same prerequisites outlined in <code>configure_cloudwatch_logs</code>.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.task_customizations" class="doc doc-heading">
<code class="highlight language-python"><span class="n">task_customizations</span><span class="p">:</span> <span class="n">JsonPatch</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>A list of JSON 6902 patches to apply to the task run request.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.task_definition" class="doc doc-heading">
<code class="highlight language-python"><span class="n">task_definition</span><span class="p">:</span> <span class="nb">dict</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>An ECS task definition to use. Prefect may set defaults or override fields on this task definition to match other <code>ECSTask</code> fields. Cannot be used with <code>task_definition_arn</code>. If not provided, Prefect will generate and register a minimal task definition.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.task_definition_arn" class="doc doc-heading">
<code class="highlight language-python"><span class="n">task_definition_arn</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>An identifier for an existing task definition to use. If fields are set on the <code>ECSTask</code> that conflict with the task definition, a new copy will be registered with the required values. Cannot be used with <code>task_definition</code>. If not provided, Prefect will generate and register a minimal task definition.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.task_role_arn" class="doc doc-heading">
<code class="highlight language-python"><span class="n">task_role_arn</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>A role to attach to the task run. This controls the permissions of the task while it is running.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.task_start_timeout_seconds" class="doc doc-heading">
<code class="highlight language-python"><span class="n">task_start_timeout_seconds</span><span class="p">:</span> <span class="nb">int</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>The amount of time to watch for the start of the ECS task before marking it as failed. The task must enter a RUNNING state to be considered started.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.task_watch_poll_interval" class="doc doc-heading">
<code class="highlight language-python"><span class="n">task_watch_poll_interval</span><span class="p">:</span> <span class="nb">float</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>The amount of time to wait between AWS API calls while monitoring the state of an ECS task.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="prefect_aws.ecs.ECSTask.vpc_id" class="doc doc-heading">
<code class="highlight language-python"><span class="n">vpc_id</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>The AWS VPC to link the task run to. This is only applicable when using the 'awsvpc' network mode for your task. FARGATE tasks require this network  mode, but for EC2 tasks the default network mode is 'bridge'. If using the 'awsvpc' network mode and this field is null, your default VPC will be used. If no default VPC can be found, the task run will fail.</p>
    </div>

  </div>






<h4 id="prefect_aws.ecs.ECSTask-methods">Methods</h4>

  <div class="doc doc-object doc-method">



<h5 id="prefect_aws.ecs.ECSTask.__json_encoder__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">__json_encoder__</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>partial(func, <em>args, </em>*keywords) - new function with partial application
of the given arguments and keywords.</p>

    </div>

  </div>




  <div class="doc doc-object doc-method">



<h5 id="prefect_aws.ecs.ECSTask.cloudwatch_logs_options_requires_configure_cloudwatch_logs" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cloudwatch_logs_options_requires_configure_cloudwatch_logs</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>Enforces that an execution role arn is provided (or could be provided by a
runtime task definition) when configuring logging.</p>

        <details class="quote">
          <summary>Source code in <code>prefect_aws/ecs.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@root_validator</span>
<span class="k">def</span> <span class="nf">cloudwatch_logs_options_requires_configure_cloudwatch_logs</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enforces that an execution role arn is provided (or could be provided by a</span>
<span class="sd">    runtime task definition) when configuring logging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cloudwatch_logs_options&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;configure_cloudwatch_logs&quot;</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;`configure_cloudwatch_log` must be enabled to use &quot;</span>
            <span class="s2">&quot;`cloudwatch_logs_options`.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="prefect_aws.ecs.ECSTask.configure_cloudwatch_logs_requires_execution_role_arn" class="doc doc-heading">
<code class="highlight language-python"><span class="n">configure_cloudwatch_logs_requires_execution_role_arn</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>Enforces that an execution role arn is provided (or could be provided by a
runtime task definition) when configuring logging.</p>

        <details class="quote">
          <summary>Source code in <code>prefect_aws/ecs.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@root_validator</span>
<span class="k">def</span> <span class="nf">configure_cloudwatch_logs_requires_execution_role_arn</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enforces that an execution role arn is provided (or could be provided by a</span>
<span class="sd">    runtime task definition) when configuring logging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;configure_cloudwatch_logs&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;execution_role_arn&quot;</span><span class="p">)</span>
        <span class="c1"># Do not raise if they&#39;ve linked to another task definition or provided</span>
        <span class="c1"># it without using our shortcuts</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_definition_arn&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_definition&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;executionRoleArn&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;An `execution_role_arn` must be provided to use &quot;</span>
            <span class="s2">&quot;`configure_cloudwatch_logs` or `stream_logs`.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="prefect_aws.ecs.ECSTask.dict" class="doc doc-heading">
<code class="highlight language-python"><span class="nb">dict</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Generate a dictionary representation of the model, optionally specifying which fields to include or exclude.</p>

        <details class="quote">
          <summary>Source code in <code>prefect_aws/ecs.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="c1"># Support serialization of the &#39;JsonPatch&#39; type</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;task_customizations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_customizations</span><span class="o">.</span><span class="n">patch</span>
    <span class="k">return</span> <span class="n">d</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="prefect_aws.ecs.ECSTask.image_is_required" class="doc doc-heading">
<code class="highlight language-python"><span class="n">image_is_required</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>Enforces that an image is available if the user sets it to <code>None</code>.</p>

        <details class="quote">
          <summary>Source code in <code>prefect_aws/ecs.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@root_validator</span>
<span class="k">def</span> <span class="nf">image_is_required</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enforces that an image is available if the user sets it to `None`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_definition_arn&quot;</span><span class="p">)</span>
        <span class="c1"># Check for an image in the task definition; whew!</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">get_prefect_container</span><span class="p">(</span>
                <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_definition&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;containerDefinitions&quot;</span><span class="p">,</span> <span class="p">[]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="ow">or</span> <span class="p">{}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;A value for the `image` field must be provided unless already &quot;</span>
            <span class="s2">&quot;present for the Prefect container definition a given task definition.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="prefect_aws.ecs.ECSTask.preview" class="doc doc-heading">
<code class="highlight language-python"><span class="n">preview</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Generate a preview of the task definition and task run that will be sent to AWS.</p>

        <details class="quote">
          <summary>Source code in <code>prefect_aws/ecs.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a preview of the task definition and task run that will be sent to AWS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">preview</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">task_definition_arn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_definition_arn</span> <span class="ow">or</span> <span class="s2">&quot;&lt;registered at runtime&gt;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_definition</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_definition_arn</span><span class="p">:</span>
        <span class="n">task_definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_task_definition</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_definition</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="n">region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aws_credentials</span><span class="o">.</span><span class="n">region_name</span>
            <span class="ow">or</span> <span class="s2">&quot;&lt;loaded from client at runtime&gt;&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">preview</span> <span class="o">+=</span> <span class="s2">&quot;---</span><span class="se">\n</span><span class="s2"># Task definition</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">preview</span> <span class="o">+=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">task_definition</span><span class="p">)</span>
        <span class="n">preview</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">task_definition</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">task_definition</span> <span class="ow">and</span> <span class="n">task_definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;networkMode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;awsvpc&quot;</span><span class="p">:</span>
        <span class="n">vpc</span> <span class="o">=</span> <span class="s2">&quot;the default VPC&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span>
        <span class="n">network_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;awsvpcConfiguration&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;subnets&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;loaded from </span><span class="si">{</span><span class="n">vpc</span><span class="si">}</span><span class="s2"> at runtime&gt;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;assignPublicIp&quot;</span><span class="p">:</span> <span class="s2">&quot;ENABLED&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">network_config</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">task_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_task_run</span><span class="p">(</span><span class="n">network_config</span><span class="p">,</span> <span class="n">task_definition_arn</span><span class="p">)</span>
    <span class="n">preview</span> <span class="o">+=</span> <span class="s2">&quot;---</span><span class="se">\n</span><span class="s2"># Task run request</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">preview</span> <span class="o">+=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">task_run</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">preview</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="prefect_aws.ecs.ECSTask.run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>Run the configured task on ECS.</p>

        <details class="quote">
          <summary>Source code in <code>prefect_aws/ecs.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@sync_compatible</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TaskStatus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ECSTaskResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the configured task on ECS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">boto_session</span><span class="p">,</span> <span class="n">ecs_client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_sync_in_worker_thread</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_session_and_client</span>
    <span class="p">)</span>

    <span class="p">(</span>
        <span class="n">task_arn</span><span class="p">,</span>
        <span class="n">cluster_arn</span><span class="p">,</span>
        <span class="n">task_definition</span><span class="p">,</span>
        <span class="n">is_new_task_definition</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_sync_in_worker_thread</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_task_and_wait_for_start</span><span class="p">,</span> <span class="n">boto_session</span><span class="p">,</span> <span class="n">ecs_client</span>
    <span class="p">)</span>

    <span class="c1"># Display a nice message indicating the command and image</span>
    <span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="ow">or</span> <span class="n">get_prefect_container</span><span class="p">(</span>
        <span class="n">task_definition</span><span class="p">[</span><span class="s2">&quot;containerDefinitions&quot;</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">: Running command </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="si">!r}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;in container </span><span class="si">{</span><span class="n">PREFECT_ECS_CONTAINER_NAME</span><span class="si">!r}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="si">}</span><span class="s2">)...&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">task_status</span><span class="p">:</span>
        <span class="n">task_status</span><span class="o">.</span><span class="n">started</span><span class="p">(</span><span class="n">task_arn</span><span class="p">)</span>

    <span class="n">status_code</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_sync_in_worker_thread</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_watch_task_and_get_exit_code</span><span class="p">,</span>
        <span class="n">task_arn</span><span class="p">,</span>
        <span class="n">cluster_arn</span><span class="p">,</span>
        <span class="n">task_definition</span><span class="p">,</span>
        <span class="n">is_new_task_definition</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_deregister_task_definition</span><span class="p">,</span>
        <span class="n">boto_session</span><span class="p">,</span>
        <span class="n">ecs_client</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ECSTaskResult</span><span class="p">(</span>
        <span class="n">identifier</span><span class="o">=</span><span class="n">task_arn</span><span class="p">,</span>
        <span class="c1"># If the container does not start the exit code can be null but we must</span>
        <span class="c1"># still report a status code. We use a -1 to indicate a special code.</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="prefect_aws.ecs.ECSTask.set_default_configure_cloudwatch_logs" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_default_configure_cloudwatch_logs</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>Streaming output generally requires CloudWatch logs to be configured.</p>
<p>To avoid entangled arguments in the simple case, <code>configure_cloudwatch_logs</code>
defaults to matching the value of <code>stream_output</code>.</p>

        <details class="quote">
          <summary>Source code in <code>prefect_aws/ecs.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@root_validator</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_default_configure_cloudwatch_logs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Streaming output generally requires CloudWatch logs to be configured.</span>

<span class="sd">    To avoid entangled arguments in the simple case, `configure_cloudwatch_logs`</span>
<span class="sd">    defaults to matching the value of `stream_output`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">configure_cloudwatch_logs</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;configure_cloudwatch_logs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">configure_cloudwatch_logs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">values</span><span class="p">[</span><span class="s2">&quot;configure_cloudwatch_logs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stream_output&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="prefect_aws.ecs.ECSTaskResult" class="doc doc-heading">
        <code>
ECSTaskResult            (<span title="prefect.infrastructure.base.InfrastructureResult">InfrastructureResult</span>)
        </code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-model"><code>pydantic-model</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>The result of a run of an ECS task</p>

        <details class="quote">
          <summary>Source code in <code>prefect_aws/ecs.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ECSTaskResult</span><span class="p">(</span><span class="n">InfrastructureResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The result of a run of an ECS task&quot;&quot;&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">














  </div>

    </div>

  </div>


<h2 id="prefect_aws.ecs-functions">Functions</h2>

  <div class="doc doc-object doc-function">



<h3 id="prefect_aws.ecs.get_container" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_container</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Extract a container from a list of containers or container definitions.
If not found, <code>None</code> is returned.</p>

        <details class="quote">
          <summary>Source code in <code>prefect_aws/ecs.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_container</span><span class="p">(</span><span class="n">containers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract a container from a list of containers or container definitions.</span>
<span class="sd">    If not found, `None` is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">containers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">container</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="prefect_aws.ecs.get_prefect_container" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_prefect_container</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Extract the Prefect container from a list of containers or container definitions.
If not found, <code>None</code> is returned.</p>

        <details class="quote">
          <summary>Source code in <code>prefect_aws/ecs.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_prefect_container</span><span class="p">(</span><span class="n">containers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the Prefect container from a list of containers or container definitions.</span>
<span class="sd">    If not found, `None` is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_container</span><span class="p">(</span><span class="n">containers</span><span class="p">,</span> <span class="n">PREFECT_ECS_CONTAINER_NAME</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../credentials/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Credentials" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Credentials
            </div>
          </div>
        </a>
      
      
        
        <a href="../s3/" class="md-footer__link md-footer__link--next" aria-label="Next: S3" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              S3
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.078830c0.min.js"></script>
      
    
  </body>
</html>